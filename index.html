<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé¨ IMBD - Dad's Magic Movie App</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f0f;
            color: white;
            line-height: 1.6;
        }

        /* Yellow IMDB Header */
        .imdbHeader {
            background: linear-gradient(135deg, #f5c518 0%, #f4d03f 100%);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(245, 197, 24, 0.3);
        }

        .headerContent {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .imdbTitle {
            font-size: 2.5rem;
            font-weight: bold;
            color: #000;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .searchContainer {
            flex: 1;
            max-width: 500px;
            margin: 0 40px;
            position: relative;
        }

        .searchInput {
            width: 100%;
            padding: 15px 20px;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            background: rgba(255,255,255,0.9);
            color: #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .searchInput:focus {
            outline: none;
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .searchSpinner {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .magicianLink {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .magicianLink:hover {
            transform: translateY(-2px);
        }

        /* Search Dropdown */
        .searchDropdownOverlay {
            position: absolute;
            top: 120px;
            left: 0;
            right: 0;
            z-index: 999999;
            pointer-events: none;
        }

        .searchDropdown {
            max-width: 500px;
            margin: 0 auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            max-height: 300px;
            overflow-y: auto;
            pointer-events: auto;
        }

        .searchResultItem {
            padding: 12px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .searchResultItem:hover {
            background: #f8f9fa;
        }

        .searchResultTitle {
            font-size: 16px;
            color: #000;
            font-weight: 500;
            flex: 1;
        }

        .searchResultYear {
            font-size: 14px;
            color: #666;
            margin-left: 12px;
        }

        /* Main Content */
        .mainContent {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Featured Section */
        .featuredSection {
            margin-bottom: 30px;
            text-align: center;
        }

        .featuredHeader {
            margin-bottom: 16px;
        }

        .featuredTitle {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
        }

        .featuredSubtitle {
            font-size: 14px;
            color: #888;
        }

        .featuredMovies {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding: 20px 0;
            scrollbar-width: none;
        }

        .featuredMovies::-webkit-scrollbar {
            display: none;
        }

        /* Genre Sections */
        .genreSection {
            margin-bottom: 30px;
        }

        .genreHeader {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .genreTitle {
            font-size: 22px;
            font-weight: bold;
            color: #fff;
        }

        .movieCount {
            font-size: 14px;
            color: #888;
        }

        .moviesRow {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding: 20px 0;
            scrollbar-width: none;
        }

        .moviesRow::-webkit-scrollbar {
            display: none;
        }

        /* Movie Posters */
        .moviePoster {
            width: 156px;
            height: 234px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            flex-shrink: 0;
        }

        .moviePoster:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.4);
        }

        .posterImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ratingBadge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.8);
            padding: 4px 8px;
            border-radius: 12px;
            border: 1px solid #FFD700;
        }

        .ratingText {
            font-size: 12px;
            font-weight: bold;
            color: #FFD700;
        }

        .posterOverlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.9);
            padding: 12px;
        }

        .movieTitle {
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            text-align: center;
            line-height: 16px;
        }

        /* Movie Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }

        .modalContent {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            position: relative;
            border: 2px solid #f5c518;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-height: 80vh;
            overflow-y: auto;
        }

        .closeButton {
            position: absolute;
            right: 20px;
            top: 20px;
            background: none;
            border: none;
            color: #f5c518;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .closeButton:hover {
            background: rgba(245, 197, 24, 0.1);
        }

        .modalHeader {
            margin-bottom: 20px;
        }

        .modalBody {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .posterContainer {
            flex-shrink: 0;
        }

        .modalPosterImage {
            width: 150px;
            height: 225px;
            object-fit: cover;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .movieInfo {
            flex: 1;
        }

        .modalMovieTitle {
            font-size: 24px;
            font-weight: bold;
            color: #f5c518;
            margin-bottom: 15px;
            line-height: 1.2;
        }

        .metaInfo {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .movieYear {
            font-size: 16px;
            color: #ccc;
        }

        .ratingContainer {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .rating {
            font-size: 16px;
            color: #FFD700;
            font-weight: bold;
        }

        .overviewSection {
            margin-bottom: 20px;
        }

        .overviewTitle {
            font-size: 18px;
            font-weight: bold;
            color: #f5c518;
            margin-bottom: 10px;
        }

        .overviewText {
            font-size: 14px;
            color: #ccc;
            line-height: 1.6;
        }

        .detailsSection {
            margin-bottom: 20px;
        }

        .detailRow {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .detailText {
            font-size: 14px;
            color: #ccc;
        }

        .modalActions {
            text-align: center;
            margin-top: 25px;
        }

        .selectButton {
            background: linear-gradient(45deg, #f5c518, #f4d03f);
            color: #000;
            padding: 15px 40px;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 8px 25px rgba(245, 197, 24, 0.3);
        }

        .selectButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(245, 197, 24, 0.4);
        }

        /* Connection Status */
        .connectionStatus {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .connectionStatus.disconnected {
            background: rgba(231, 76, 60, 0.9);
        }

        /* Loading */
        .loadingContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            gap: 20px;
        }

        .loadingText {
            font-size: 18px;
            color: #ccc;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .headerContent {
                flex-direction: column;
                gap: 20px;
            }

            .searchContainer {
                margin: 0;
                max-width: 100%;
            }

            .modalBody {
                flex-direction: column;
                text-align: center;
            }

            .modalContent {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Yellow IMDB Header -->
    <header class="imdbHeader">
        <div class="headerContent">
            <div class="imdbTitle">IMBD</div>
            
            <div class="searchContainer">
                <input type="text" class="searchInput" placeholder="Search movies..." id="searchInput">
                <div class="searchSpinner" id="searchSpinner" style="display: none;">‚è≥</div>
            </div>
            
            <a href="magician.html" class="magicianLink">üé© Magician View</a>
        </div>
    </header>

    <!-- Search Dropdown -->
    <div class="searchDropdownOverlay" id="searchDropdownOverlay" style="display: none;">
        <div class="searchDropdown" id="searchDropdown">
            <!-- Search results will appear here -->
        </div>
    </div>

    <!-- Main Content -->
    <main class="mainContent" id="mainContent">
        <!-- Loading State -->
        <div class="loadingContainer" id="loadingContainer">
            <div class="loadingText">Loading movies...</div>
        </div>

        <!-- Featured Movies Section -->
        <section class="featuredSection" id="featuredSection" style="display: none;">
            <div class="featuredHeader">
                <h2 class="featuredTitle">Featured Movies</h2>
                <p class="featuredSubtitle">Top 10 Highest-Rated Films of All Time</p>
            </div>
            <div class="featuredMovies" id="featuredMovies">
                <!-- Featured movies will be loaded here -->
            </div>
        </section>

        <!-- Genre Sections will be dynamically generated -->
        <div id="genreSections">
            <!-- Genre sections will be loaded here -->
        </div>
    </main>

    <!-- Movie Modal -->
    <div id="movieModal" class="modal">
        <div class="modalContent">
            <button class="closeButton" onclick="closeModal()">√ó</button>
            <div class="modalHeader">
                <!-- Modal header content -->
            </div>
            <div class="modalBody" id="modalBody">
                <!-- Modal content will be loaded here -->
            </div>
            <div class="modalActions">
                <button class="selectButton" onclick="selectMovie()">üéØ Select This Movie</button>
            </div>
        </div>
    </div>

    <!-- Connection Status -->
    <div class="connectionStatus" id="connectionStatus">
        üîå Connected to Magician
    </div>

    <script>
        // Configuration
        const TMDB_API_KEY = '462b797169ca3170f8971775670b86ac'; // Your TMDB API key
        const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
        const SOCKET_SERVER_URL = 'http://192.168.1.99:3001';

        // State
        let genres = [];
        let moviesByGenre = {};
        let featuredMovies = [];
        let selectedMovie = null;
        let socket = null;
        let searchTimeout = null;

        // Initialize the app
        async function initApp() {
            try {
                await loadGenresAndMovies();
                setupSocket();
                setupSearch();
                hideLoading();
            } catch (error) {
                console.error('Error initializing app:', error);
                // Fallback to sample data if API fails
                loadSampleData();
                hideLoading();
            }
        }

        // Load genres and movies from TMDB API
        async function loadGenresAndMovies() {
            try {
                // Load featured movies (top rated)
                const topMovies = await fetch(`${TMDB_BASE_URL}/movie/top_rated?api_key=${TMDB_API_KEY}&language=en-US&page=1`)
                    .then(res => res.json());
                
                featuredMovies = topMovies.results.slice(0, 10);
                renderFeaturedMovies();

                // Load genres
                const genresResponse = await fetch(`${TMDB_BASE_URL}/genre/movie/list?api_key=${TMDB_API_KEY}&language=en-US`);
                const genresData = await genresResponse.json();
                
                // Filter and sort genres
                const priorityGenres = ['Action', 'Comedy', 'Drama', 'Thriller', 'Horror', 'Romance', 'Adventure', 'Sci-Fi', 'Animation', 'Fantasy'];
                genres = genresData.genres.filter(genre => 
                    priorityGenres.includes(genre.name) && 
                    genre.name !== 'Documentary' && 
                    genre.name !== 'TV Movie'
                ).sort((a, b) => {
                    const aPriority = priorityGenres.indexOf(a.name);
                    const bPriority = priorityGenres.indexOf(b.name);
                    return aPriority - bPriority;
                });

                // Load movies for each genre
                for (const genre of genres) {
                    const moviesResponse = await fetch(`${TMDB_BASE_URL}/discover/movie?api_key=${TMDB_API_KEY}&language=en-US&sort_by=popularity.desc&include_adult=false&include_video=false&page=1&with_genres=${genre.id}`);
                    const moviesData = await moviesResponse.json();
                    moviesByGenre[genre.id] = moviesData.results.slice(0, 20);
                }

                renderGenreSections();
            } catch (error) {
                console.error('Error loading from TMDB:', error);
                throw error;
            }
        }

        // Fallback to sample data
        function loadSampleData() {
            featuredMovies = [
                {
                    id: 1,
                    title: "The Shawshank Redemption",
                    poster_path: "/q6y0Go1tsGEsmtFryDOJo3dEmqu.jpg",
                    vote_average: 9.3,
                    release_date: "1994-09-22"
                },
                {
                    id: 2,
                    title: "The Godfather",
                    poster_path: "/3bhkrj58Vtu7enYsRolD1fZdja1.jpg",
                    vote_average: 9.2,
                    release_date: "1972-03-14"
                },
                {
                    id: 3,
                    title: "The Dark Knight",
                    poster_path: "/qJ2tW6WMUDux911r6m7haRef0WH.jpg",
                    vote_average: 9.0,
                    release_date: "2008-07-16"
                }
            ];

            genres = [
                { id: 28, name: "Action" },
                { id: 35, name: "Comedy" },
                { id: 18, name: "Drama" },
                { id: 27, name: "Horror" }
            ];

            moviesByGenre = {
                28: [
                    {
                        id: 4,
                        title: "Gladiator",
                        poster_path: "/6WBIuCWMmSS2bLu2u6XbVwu7cdn.jpg",
                        vote_average: 8.5,
                        release_date: "2000-05-01"
                    },
                    {
                        id: 5,
                        title: "The Matrix",
                        poster_path: "/f89U3ADr1oiB1s9GkdPOEpXUk5H.jpg",
                        vote_average: 8.7,
                        release_date: "1999-03-30"
                    }
                ],
                35: [
                    {
                        id: 6,
                        title: "Fight Club",
                        poster_path: "/pB8BM7pdSp6B6Ih7QZ4DrQ3PmJK.jpg",
                        vote_average: 8.8,
                        release_date: "1999-10-15"
                    }
                ],
                18: [
                    {
                        id: 7,
                        title: "Schindler's List",
                        poster_path: "/sF1U4EUQS8YHUAHk6zpd9RCkzL2.jpg",
                        vote_average: 8.9,
                        release_date: "1993-11-30"
                    }
                ]
            };

            renderFeaturedMovies();
            renderGenreSections();
        }

        // Render featured movies
        function renderFeaturedMovies() {
            const container = document.getElementById('featuredMovies');
            container.innerHTML = '';

            featuredMovies.forEach(movie => {
                const movieElement = createMoviePoster(movie);
                container.appendChild(movieElement);
            });

            document.getElementById('featuredSection').style.display = 'block';
        }

        // Render genre sections
        function renderGenreSections() {
            const container = document.getElementById('genreSections');
            container.innerHTML = '';

            genres.forEach(genre => {
                const movies = moviesByGenre[genre.id] || [];
                if (movies.length === 0) return;

                const section = document.createElement('section');
                section.className = 'genreSection';
                section.innerHTML = `
                    <div class="genreHeader">
                        <h2 class="genreTitle">${genre.name}</h2>
                        <span class="movieCount">${movies.length} movies</span>
                    </div>
                    <div class="moviesRow" id="genre-${genre.id}">
                        <!-- Movies will be loaded here -->
                    </div>
                `;

                container.appendChild(section);

                // Load movies for this genre
                const moviesContainer = section.querySelector(`#genre-${genre.id}`);
                movies.forEach(movie => {
                    const movieElement = createMoviePoster(movie);
                    moviesContainer.appendChild(movieElement);
                });
            });
        }

        // Create movie poster element
        function createMoviePoster(movie) {
            const poster = document.createElement('div');
            poster.className = 'moviePoster';
            poster.onclick = () => showMovieModal(movie);

            const posterUrl = movie.poster_path 
                ? `https://image.tmdb.org/t/p/w500${movie.poster_path}`
                : 'https://via.placeholder.com/156x234/333/666?text=Movie';

            poster.innerHTML = `
                <img src="${posterUrl}" alt="${movie.title}" class="posterImage" 
                     onerror="this.src='https://via.placeholder.com/156x234/333/666?text=Movie'">
                ${movie.vote_average ? `
                    <div class="ratingBadge">
                        <span class="ratingText">‚òÖ ${movie.vote_average.toFixed(1)}</span>
                    </div>
                ` : ''}
                <div class="posterOverlay">
                    <div class="movieTitle">${movie.title}</div>
                </div>
            `;

            return poster;
        }

        // Show movie modal
        function showMovieModal(movie) {
            selectedMovie = movie;
            
            const modalBody = document.getElementById('modalBody');
            const posterUrl = movie.poster_path 
                ? `https://image.tmdb.org/t/p/w500${movie.poster_path}`
                : 'https://via.placeholder.com/150x225/333/666?text=Movie';

            modalBody.innerHTML = `
                <div class="posterContainer">
                    <img src="${posterUrl}" alt="${movie.title}" class="modalPosterImage"
                         onerror="this.src='https://via.placeholder.com/150x225/333/666?text=Movie'">
                </div>
                <div class="movieInfo">
                    <h2 class="modalMovieTitle">${movie.title}</h2>
                    <div class="metaInfo">
                        <span class="movieYear">${new Date(movie.release_date).getFullYear()}</span>
                        ${movie.vote_average ? `
                            <div class="ratingContainer">
                                <span class="rating">‚òÖ ${movie.vote_average.toFixed(1)}</span>
                            </div>
                        ` : ''}
                    </div>
                    ${movie.overview ? `
                        <div class="overviewSection">
                            <h3 class="overviewTitle">Overview</h3>
                            <p class="overviewText">${movie.overview}</p>
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('movieModal').style.display = 'block';
        }

        // Close modal
        function closeModal() {
            document.getElementById('movieModal').style.display = 'none';
            selectedMovie = null;
        }

        // Select movie (send to magician)
        function selectMovie() {
            if (selectedMovie && socket) {
                socket.emit('movieSelected', {
                    title: selectedMovie.title,
                    year: new Date(selectedMovie.release_date).getFullYear(),
                    poster: `https://image.tmdb.org/t/p/w500${selectedMovie.poster_path}`,
                    rating: selectedMovie.vote_average ? selectedMovie.vote_average.toFixed(1) : 'N/A',
                    genre: selectedMovie.genre_ids ? getGenreName(selectedMovie.genre_ids[0]) : 'Unknown'
                });

                // Show success message
                const btn = document.querySelector('.selectButton');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Movie Sent!';
                btn.style.background = 'linear-gradient(45deg, #27ae60, #2ecc71)';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = 'linear-gradient(45deg, #f5c518, #f4d03f)';
                }, 2000);

                closeModal();
            }
        }

        // Get genre name by ID
        function getGenreName(genreId) {
            const genre = genres.find(g => g.id === genreId);
            return genre ? genre.name : 'Unknown';
        }

        // Setup socket connection
        function setupSocket() {
            socket = io(SOCKET_SERVER_URL);

            socket.on('connect', () => {
                console.log('Connected to socket server');
                document.getElementById('connectionStatus').textContent = 'üîå Connected to Magician';
                document.getElementById('connectionStatus').classList.remove('disconnected');
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from socket server');
                document.getElementById('connectionStatus').textContent = '‚ùå Disconnected from Magician';
                document.getElementById('connectionStatus').classList.add('disconnected');
            });
        }

        // Setup search functionality
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }

                if (query.length === 0) {
                    hideSearchDropdown();
                    return;
                }

                if (query.length < 2) {
                    hideSearchDropdown();
                    return;
                }

                // Show loading spinner
                document.getElementById('searchSpinner').style.display = 'block';

                searchTimeout = setTimeout(() => {
                    performSearch(query);
                }, 300);
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.searchContainer') && !e.target.closest('.searchDropdown')) {
                    hideSearchDropdown();
                }
            });
        }

        // Perform search
        async function performSearch(query) {
            try {
                const response = await fetch(`${TMDB_BASE_URL}/search/movie?api_key=${TMDB_API_KEY}&language=en-US&query=${encodeURIComponent(query)}&page=1&include_adult=false`);
                const data = await response.json();
                
                showSearchResults(data.results.slice(0, 8));
            } catch (error) {
                console.error('Search error:', error);
                showSearchResults([]);
            } finally {
                document.getElementById('searchSpinner').style.display = 'none';
            }
        }

        // Show search results
        function showSearchResults(results) {
            const dropdown = document.getElementById('searchDropdown');
            const overlay = document.getElementById('searchDropdownOverlay');

            if (results.length === 0) {
                dropdown.innerHTML = '<div class="searchResultItem"><span>No movies found</span></div>';
            } else {
                dropdown.innerHTML = results.map(movie => `
                    <div class="searchResultItem" onclick="selectMovieFromSearch(${JSON.stringify(movie).replace(/"/g, '&quot;')})">
                        <span class="searchResultTitle">${movie.title}</span>
                        <span class="searchResultYear">${new Date(movie.release_date).getFullYear()}</span>
                    </div>
                `).join('');
            }

            overlay.style.display = 'block';
        }

        // Hide search dropdown
        function hideSearchDropdown() {
            document.getElementById('searchDropdownOverlay').style.display = 'none';
        }

        // Select movie from search
        function selectMovieFromSearch(movie) {
            document.getElementById('searchInput').value = '';
            hideSearchDropdown();
            showMovieModal(movie);
        }

        // Hide loading
        function hideLoading() {
            document.getElementById('loadingContainer').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('movieModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
